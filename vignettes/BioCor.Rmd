---
title: "BioCor"
author: '[Lluís Revilla](mailto:lrevilla@clinic.cat)'
date: '`r BiocStyle::doc_date()`'
package: '`r BiocStyle::pkg_ver("BioCor")`'
output:
  BiocStyle::pdf_document:
    fig_caption: yes
    toc: yes
    toc_depth: 3
  BiocStyle::html_document:
    fig_caption: yes
    toc_float: yes
    toc_depth: 3

vignette: >
  %\VignetteIndexEntry{BioCor}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---
```{r knitsetup, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_knit$set(root.dir = ".")
knitr::opts_chunk$set(fig.width = 20, fig.height = 20, collapse = TRUE)
BiocStyle::markdown()
```


# Introduction

Functional similarities have already been used to several purposes, most of them are based on Gene Ontology, which can be calculated using `r BiocStyle::Biocpkg("GOSemSim")`, or other controlled vocabulary.

General methods for similarity between to sets has been proposed Jaccard and Dice. However they have not been used to compare the similarity of pathways, or genes, neither between genes and pathways nor between databases. With this package we provide the methods to calculate such similarities with flexibility.

Here we provides functions to calculate similarities for pathways, genes and clusters of genes. As it development started aiming to group better genes by functionality in co-expression networks using *[WGCNA](https://cran.r-project.org/package=WGCNA)*.

# Citation
The main article describing how it has been applied, is currently under writing.

# Installation
The BioCor package will be available at bioconductor.org and will be downloaded and installed via biocLite:
```{r install, eval=FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("BioCor")
```

You can install the latest version of `r BiocStyle::Githubpkg("llrs/BioCor")` from Github with:
```{r github, eval = FALSE}
library("devtools")
install_github("llrs/BioCor")
```

# Using BioCor

## Preparation

We can load the package and prepare the data for which we want to calculate the similarities:
```{r load}
library("BioCor")
# Load libraries with the data of the pathways
library("org.Hs.eg.db")
library("reactome.db")
# Prepare the data
genes.kegg <- as.list(org.Hs.egPATH)
genes.react <- as.list(reactomeEXTID2PATHID)
```

To avoid having biased data it is important to have all the data about the pathways and genes associated to all pathways for organism under study. Here we assume that we are interested in human pathways. We use this two databases KEGG and Reactome as they are easy to obtain the data. However KEGG database is no longer free for large retrievals therefore it is not longer updated in the Bioconductor annotation packages.


## Pathway similarities

We can compute similarities between two pathways or between several pathways and combine them, or not:
```{r pathSim}
pathSim("112310", "1500931", genes.react)

pathways <- c("112310", "112315", "112316", "373753", "916853", "109582", 
              "114608")
mpathSim(pathways, genes.react, NULL)
```
In row-wise we have the pathways of the first argument and column-wise the pathways of the second argument.

### Combining values {#combining}
To combine values we provide a function with several methods:
```{r combineScores}
sim <- mpathSim(pathways, genes.react, NULL)
methodsCombineScores <- c("avg", "max", "rcmax", "rcmax.avg", "BMA")
sapply(methodsCombineScores, combineScores, scores = sim)
```
We can also specify the method to combine the similarities in `pathSim`, `mpathSim`, `geneSim`, `mgeneSim`, `clusterSim`, `mclusterSim`, `clusterGeneSim` and `mclusterGeneSim`, argument method, by default it is the "max" method to combine pathways and BMA to combine similarities of genes or for cluster analysis.

## Gene similarities {#geneSim}
To calculate a single pair of comparisons there are the `geneSim` and `mgeneSim` function for several comparisons. In this example we compare the genes BRCA1 and BRCA2 and NAT2:
```{r geneSim}
geneSim("672", "675", genes.kegg)
geneSim("672", "675", genes.react)

mgeneSim(c("672", "675", "10"), genes.kegg)
mgeneSim(c("672", "675", "10"), genes.react)
```

Note that for the same genes each database has different annotations, which result on different similarity scores. In this example the gene 672 has `r ncol(geneSim("672", "675", genes.kegg, "ENTREZID", "PATH", NULL))` and `r ncol(geneSim("672", "675", genes.react, "ENTREZID", "REACTOMEID", NULL))` pathways in KEGG and Reactome respectively and the gene 675 has `r nrow(geneSim("672", "675", genes.kegg, "ENTREZID", "PATH", NULL))` and `r nrow(geneSim("672", "675", genes.react, "ENTREZID", "REACTOMEID", NULL))` pathways in KEGG and Reactome respectively which results on different scores.

## Gene cluster similarities

There are two methods:  
* Combining all the unique pathways for each cluster and then compare between them
* Calculate the similarity between the genes of a cluster and combine the similarities for each gene of a cluster

### Cluster similarity by pathways similarities of the clusters

If a method to combine pathways similarities is not provided all pathway similarities are returned:
```{r clusterSim}
clusterSim(c("672", "675"), c("100", "10", "1"), genes.kegg)
clusterSim(c("672", "675"), c("100", "10", "1"), genes.kegg, NULL)

clusters <- list(cluster1 = c("672", "675"),
                 cluster2 = c("100", "10", "1"),
                 cluster3 = c("18", "10", "83"))
mclusterSim(clusters, genes.kegg, "rcmax.avg")
```

### Cluster similarity by genes similarity of the clusters

In this method we need to specify two methods to combine values, the first one to combine pathway similarities, the second to combine gene similarities. If only one is provided it returns the matrix of both similarities of the genes of each cluster:
```{r clusterGeneSim}
clusterGeneSim(c("672", "675"), c("100", "10", "1"), genes.kegg)
clusterGeneSim(c("672", "675"), c("100", "10", "1"), genes.kegg, "max")

mclusterGeneSim(clusters, genes.kegg, c("max", "rcmax.avg"))
```

Note the differences between each method in the similarity values of the clusters  with the same information.

## Merging similarities
If one calculate similarities for with KEGG data and Reactome or other input for the same genes or clusters we provide a couple of functions to merge them:

We can set a weight to each similarity input with `weighted.sum`, multiply them but using also a weight for each, doing the mean or just adding them up
```{r merging}
kegg <- mgeneSim(c("672", "675", "10"), genes.kegg)
react <- mgeneSim(c("672", "675", "10"), genes.react)
# We can sum it adding a weight to each origin
weighted.sum(c(kegg["672", "675"], react["672","675"]), w = c(0.3, 0.7))

# Or if we want to perform for all the matrix
# A list of matrices to merge
sim <- list("kegg" = kegg, "react" = react)
# And call similarities and a function to apply
similarities(sim, weighted.sum, w = c(0.3, 0.7))
similarities(sim, weighted.prod, w = c(0.3, 0.7))
similarities(sim, prod)
similarities(sim, mean)
```

# High volumes of gene similarities
If we want multiple gene pair-wise comparisons we can use bioCor, which accepts a parallel back-end:
```{r big, collapse=TRUE}
genes.id <- c("10", "15", "16", "18", "2", "9", "52", "3855", "3880", "644", 
              "81327", "9128", "2073", "2893", "5142", "60", "210", "81", 
              "1352", "88")
library("BiocParallel")
sim <- bioCor(genes.id, all = TRUE, BPPARAM = MulticoreParam())
str(sim)
```

Now in `sim` we have a list of matrices of `r nrow(sim[[1]])` rows and columns with similarities from both, Reactome and KEGG database.

# An example of usages
With the genes in the previous list we are going to see how similar are those genes:
```{r hclust1}
# Calculate the similarity 
react <- mgeneSim(genes.id, genes.react)
# We need to remove colums with too much NA
nas <- apply(react, 1, function(x){sum(is.na(x))})
react <- react[nas <= 10, nas <= 10]
plot(hclust(as.dist(1 - react))) #We plot the relationship between the genes
```
As we can see there are a couple of genes which are not related to others in the list the 2073 and the 81.

Now we add the two genes mores the BRCA1 and BRCA2 which have the entrez identification 672 and 675.
```{r hclust2} 
react2 <- mgeneSim(c(genes.id, "672", "675"), genes.react)
info <- select(org.Hs.eg.db, keys = c(genes.id, "675", "672"), keytype = "ENTREZID",
       columns = c("SYMBOL", "GENENAME"))
# We change the ENTREZID genes for the Symbols
colnames(react2) <- info$SYMBOL
rownames(react2) <- info$SYMBOL
# We need to remove colums with too much NA
nas <- apply(react2, 1, function(x){sum(is.na(x))})
react2 <- react2[nas <= 10, nas <= 10]
plot(hclust(as.dist(1 - react2))) 
info
```

We can see now that the gene 2073 is the ERCC5 related with BRCA1 and BRCA2, as the name indicates all three are linked to DNA. We can also observe that the actinin alpha 4 and 2 are involved in different functions, and there is a pair of genes related to RNA, another group is not clear what functions do they do. Two groups are related to metabolism one about acetil metabolism and another more general.

We can group them for a cluster analysis to visualize the relationship between the clusters:
```{r hclust3}
clusters <- list(DNA = c("672", "675", "2073"),
                 RNA = c("16", "9128"),
                 acetil_metabolism = c("10", "15", "9", "644", "210", "1352"),
                 metabolism = c("18", "2893", "88"), 
                 unknown = c("2", "81327", "5142", "60"))
# Remember we can use both methods to compare clusters
sim_clus1 <- mclusterSim(clusters, genes.react, "ENTREZID", "REACTOMEID")
plot(hclust(as.dist(1 - sim_clus1)))
sim_clus2 <- mclusterGeneSim(clusters, genes.react, "ENTREZID", "REACTOMEID")
plot(hclust(as.dist(1 - sim_clus2)))
```
As we can see each method results in a different dendrogram, but the second is more accurate to describe the relationships between the genes in the clusters.

# FAQ

## How do you calculate how similar are two pathways ?
It uses the [Sørensen–Dice index](https://en.wikipedia.org/wiki/S%C3%B8rensen%E2%80%93Dice_coefficient): 
It is the double of the genes shared by the pathways divided by the number of genes in each pathway.

We can calculate the similarity between two pathways ($x$, $w$) with:

$$Dice(x, w) = \frac{2 |x \cap y|}{|x| + |y|}$$

This is implemented in the `diceSim` function, which results is similar to Jaccard index:

$$Jaccard(x, w) = \frac{|x \cap w|}{|x \cup w|}$$

Both Jaccard index and Dice index are between 0 and 1 ($[0, 1]$). To calculate the Jaccard index from the `diceSim` use the `D2J` function.

## Why do you use the dice coefficient and not the Jaccard ?
We consider Dice coefficient better than Jaccard because it has higher values for the same comparisons. Also to include a gene in a pathway is difficult and it is a way to reward the known interactions. 

## How do you combine similarities between several pathways of two genes?
Although the recommend method is the "max" method, (set as default), there are implemented other methods in `combineScores` of the `r BiocStyle::Biocpkg("GOSemSim")` package which I borrowed. See the [Combining values section]({#combining}) and the help page of `combineScores`.

## Why do you recommend using the max method to combine similarities scores for pathways?
The purpose of combining the scores is usually to know which genes or which relationships between pathways are more relevant. The higher the similarity is between two pathway of two genes, the higher functionalities do the genes share, so even if those genes could be less related, this value would be the maximum functional relationship between them. 

## How to detect which functional relationship is more important between two genes?
To detect which relationship is more important between two genes one could either measure other similarities scores or check the stechiometric of the pathways and measure the expression changes and correlation between them.

## How to detect with which genes is my gene of interest related?
You can measure the [gene similarity](#geneSim) between those genes and also measure the expression correlation of your gene of interest with other genes. 

## Why isn't available a method for calculating GO similarities?
This is covered by the `r BiocStyle::Biocpkg("GOSemSim")` package, you can use it to produce a similarity matrix (i.e. use `mgeneSim`). You can parallelize it with `foreach` package or `BiocParallel` if your list of genes is big. 

## How does bioCor deal when one gene is mapped to several ones?
It keeps the one with the higher mean similarity for all the genes available in the comparison. That means that for a different comparison depending on which genes you are computing a gene can have different values. 

# WGCNA and BioCor 

BioCor was originally thought to be used with other clustering packages using similarity measures like `r BiocStyle::CRANpkg("WGCNA")`, does. Here we provide an example on how to use BioCor with WGCNA, assuming we have already calculated the similarities in the list `sim`.

Steps:
1. Calculate the similarities for the expression data 
2. Calculate the similarities of the genes in the expression data as described previously
3. Join the similarities and use them to calculate the adjacency (`adjacency.fromSimilarity(similarity)`)
4. Build the dendrogram to obtain the modules of related genes.

```{r wgcna, eval=FALSE}
# Load the expression data see tutorial 1 of WGCNA
load("expression.RData", verbose = TRUE)
expr.sim <- WGCNA::cor(expr) # or bicor

# To combine the similarities either weighted.sum :
similarity <- similarities(c(list(exp = expr.sim), sim), mean)

# Choose the softThreshold
pSFT <- pickSoftThreshold.fromSimilarity(similarity)

# Or any other function we want
adjacency <- adjacency.fromSimilarity(similarity, power = powerEstimate)

# Once we have the similarities we can calculate the TOM with TOM
TOM <- TOMsimilarity(adjacency)
dissTOM <- 1 - TOM
geneTree <- hclust(as.dist(dissTOM), method = "average")
# We can use a clustering tool to group the genes
dynamicMods <- cutreeHybrid(dendro = geneTree, distM = dissTOM,
                            deepSplit = 2, pamRespectsDendro = FALSE,
                            minClusterSize = 30)
moduleColors <- labels2colors(dynamicMods$labels) 
```

We can similarly apply the similarity of BioCor after calculating the adjacency by pure expression correlation, and using it with low weight:

```{r wgcna, eval=FALSE}
# Load the expression data see tutorial 1 of WGCNA
load("expression.RData", verbose = TRUE)
# set the power necessary for a scale free topology based only in the expression
expr.adj <- adjacency(expr) 

# To combine the similarities either weighted.sum :
similarity <- similarities(c(list(exp = expr.adj), sim), 
                           weighted.sum, w = c(0.8, 0.1, 0.1))
# Or the mean
similarity <- similarities(c(list(exp = expr.sim), sim), mean) 
# Or any other function we want

# Once we have the similarities we can calculate the TOM with TOM
TOM <- TOMsimilarity(similarity)
dissTOM <- 1 - TOM
geneTree <- hclust(as.dist(dissTOM), method = "average")
# We can use a clustering tool to group the genes
dynamicMods <- cutreeHybrid(dendro = geneTree, distM = dissTOM,
                            deepSplit = 2, pamRespectsDendro = FALSE,
                            minClusterSize = 30)
moduleColors <- labels2colors(dynamicMods$labels) 
```
Once the modules are identified using the functional similarities of this package and the gene correlations, one can continue with the workflow of WGCNA.

# Session Info

```{r session}
sessionInfo()
```
